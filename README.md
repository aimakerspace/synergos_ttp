1) **Clone this repository**

    > <font color='turquoise'>**git clone https://gitlab.int.aisingapore.org/aims/federatedlearning/pysyft_ttp.git**</font>

2) **Navigate into the repository**

    > <font color='turquoise'>**cd ./pysyft_ttp**</font>

3) **Build image using the following command(s):** 

    > <font color='turquoise'>**docker build -t ttp:pysyft_demo --label "WebsocketClientWorker" .**</font>

4) **Make sure that the worker containers have already started running (i.e. primed for WS handshake. Instructions for worker startup can be found [here](<insert link-to-worker-readme.md here>).**

5) **Set up the appropriate mountpoint directories.**

    A. Data

    > <font color='turquoise'>**/data <br>&ensp;&ensp;&ensp;&ensp;< no structural requirements >**</font>

    There are no structural requirements for the `outputs` directory. This internal directory is meant to be overridden by your own data directory (refer to section 5 for more information). Database files are generated by the system here.

    B. Outputs

    > <font color='turquoise'>**/outputs <br>&ensp;&ensp;&ensp;&ensp;< no structural requirements >**</font>

    There are no structural requirements for the `outputs` directory. This internal directory is meant to be overridden by your own data directory (refer to section 5 for more information). Cached file outputs from federated processes are found here.

    C. MLFlow Cache Directory

    > <font color='turquoise'>**/outputs <br>&ensp;&ensp;&ensp;&ensp;< no structural requirements >**</font>

    There are no structural requirements for the `outputs` directory. This internal directory is meant to be overridden by your own data directory (refer to section 5 for more information). Cached files generated from MLFlow logging will be exported here, where they can be fed as backend-URIs to an MLFlow server for analyses and visualisation.

6) **Start up the TTP node. Start-up commands can be reduced depending on whether or not you are running the REST-RPC grid in standalone mode, or over a distributed network. In general, it is as follows:**

    ><font color='turquoise'>**docker run <br><font color='red'>-p <host\>:<f_port\>:5000 <br> -p <host\>:<ws_port\>:8020</font><br><font color='orange'>-v /path/to/data_export_directory:/ttp/data <br> -v /path/to/outputs_export_directory:/ttp/outputs <br> -v /path/to/mlflow_export_directory:/ttp/mlflow</font><br> --name ttp ttp:pysyft_demo**</font>

    Let's try to break down what is going on here.

    A. Port Routes
    ><font color='red'>-p <host\>:<f_port\>:5000 <br> -p <host\>:<ws_port\>:8020</font>

    This section maps the incoming connections into the container. 
    
    In the REST-RPC worker, the 2 main services hosted are:
        
    1. Static REST service

        * Driven by Flask
        * Receives triggers from REST-RPC TTP

    2. Dynamically initialised websocket connection

        * Primarily used by PySyft workers for finetuned federated orchestration.
        * Only active when PySyft's `WebsocketClientWorkers` (WSCWs) have been initialised to complete the websocket connecton with the worker nodes' `WebsocketServerWorkers` (WSSWs) (internally handled)
        * Deactivates when WSCWs are destroyed (internally handled)

    Glossary:
     
    * host - IP of host machine
    * f_port - Selected port to route incoming HTTP connections for the REST service
    * ws_port - Selected port to route incoming Websocket connections for the PySyft Websocket workers

    B. Volume Mounts

    <font color='orange'>-v /path/to/data_export_directory:/ttp/data <br> -v /path/to/outputs_export_directory:/ttp/outputs <br> -v /path/to/mlflow_export_directory:/ttp/mlflow</font>

    As mentioned in step 5., override the internal directories of the containers with the mountable directories you have created.

    C. Launch Examples

    I. Standalone Grid (i.e. local)

    ><font color='turquoise'>**docker run <br> -p <f_port>:5000<br>-v /path/to/data_export_directory:/ttp/data <br> -v /path/to/outputs_export_directory:/ttp/outputs <br> -v /path/to/mlflow_export_directory:/ttp/mlflow <br>--name ttp ttp:pysyft_demo**</font>
     
    In a standalone grid, docker's bridge network automatically assigns an IP to each container. This means that each container has a unique IP and thus is not required to perform port routing. However, you will still have to reroute a port so that the container can receive instructions from the driver node (i.e. machine that the TTP user is on)

    > To find your container IDs, use either <br>`docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' container_name_or_id` for modern version of docker, or <br>`docker inspect --format '{{ .NetworkSettings.IPAddress }}' container_name_or_id` for the previous versions.

    II. Distributed Servers (i.e. across multiple devices)

    ><font color='turquoise'>**docker run <br><font color='red'>-p <host\>:<f_port\>:5000 <br> -p <host\>:<ws_port\>:8020</font><br><font color='orange'>-v /path/to/data_export_directory:/ttp/data <br> -v /path/to/outputs_export_directory:/ttp/outputs <br> -v /path/to/mlflow_export_directory:/ttp/mlflow</font><br> --name ttp ttp:pysyft_demo**</font>
    
    For a guided tutorial, 
    1. Download worker inputs [here](https://drive.google.com/drive/folders/1hSoOq1z-Lo3w-qUrFbsoPITzIyYWivvD?usp=sharing)
    2. Download test datasets [here](https://drive.google.com/drive/folders/19C9m6XEPHeEMIwmPRajX5-UBNujGOdtM?usp=sharing)
    3. Refer to this [guide](https://gitlab.int.aisingapore.org/aims/federatedlearning/fedlearn-prototype/-/wikis/PySyft/How-to-run-jobs-in-PySyft).

